name: piBuild
on:
  push:
    branches:
      - '*'
jobs:
  build:
    name: Build
    runs-on: self-hosted
    steps:
      - name: Check branch tag
        run: |
          if [[ ${{ github.ref }} != *"_piBuild"* ]]; then
            exit 0
          fi
      - name: Gradle Build
        env:
          hibp_api_key: ${{ secrets.HIBP_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Needed to get PR information, if any
        run: ./gradlew shadowJar
      - name: Deploy
        run: |
          file=$(find build/libs -name 'hibp-*-all.jar' -type f)
          pm2 stop hibp
          rm ~/test/hibp-0.0.1-all.jar
          cp "$file" ~/test/hibp-0.0.1-all.jar
          pm2 start hibp
